<?php
session_start();

if (!isset($_SESSION["admin_loggedin"]) || $_SESSION["admin_loggedin"] !== true || $_SESSION["admin_role"] !== 'Admin') {
    $_SESSION['error_message'] = "You are not authorized to access this page."; // Use a generic session message key
    header("location: admin-login.php");
    exit;
}

require_once __DIR__ . '/config.php';

$fullname_input = $username_input = $email_input = $role_input = "";
$password_input_raw = "";
$errors = [];
$allowed_roles = ['Admin', 'Editor', 'Writer'];

$success_message_from_session = "";
if (isset($_SESSION['success_message'])) {
    $success_message_from_session = $_SESSION['success_message'];
    unset($_SESSION['success_message']);
}

$error_message_from_session = "";
if (isset($_SESSION['error_message'])) {
    $error_message_from_session = $_SESSION['error_message'];
    unset($_SESSION['error_message']);
}


if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $fullname_input = trim($_POST["fullname"]);
    $username_input = trim($_POST["username"]);
    $email_input = trim($_POST["email"]);
    $password_input_raw = trim($_POST["password"]);
    $confirm_password_input = trim($_POST["confirm-password"]);
    $role_input = isset($_POST["role"]) ? trim($_POST["role"]) : "";

    if (empty($fullname_input)) {
        $errors['fullname'] = "Please enter full name.";
    } elseif (!preg_match("/^[a-zA-Z-' ]*$/", $fullname_input)) {
        $errors['fullname'] = "Full name can only contain letters, hyphens, apostrophes, and spaces.";
    }

    if (empty($username_input)) {
        $errors['username'] = "Please enter a username.";
    } elseif (!preg_match('/^[a-zA-Z0-9_.]{3,30}$/', $username_input)) {
        $errors['username'] = "Username must be 3-30 characters and can only contain letters, numbers, full stops and underscores.";
    } else {
        $sql_check_username = "SELECT id FROM Users WHERE username = ?";
        if ($stmt_check_username = $mysqli->prepare($sql_check_username)) {
            $stmt_check_username->bind_param("s", $param_username_check);
            $param_username_check = $username_input;
            if ($stmt_check_username->execute()) {
                $stmt_check_username->store_result();
                if ($stmt_check_username->num_rows > 0) {
                    $errors['username'] = "This username is already taken.";
                }
            } else {
                $errors['general'] = "Error checking username uniqueness. Please try again.";
                error_log("Error executing username check: " . $stmt_check_username->error);
            }
            $stmt_check_username->close();
        } else {
            $errors['general'] = "Database error while checking username. Please try again.";
            error_log("Error preparing username check: " . $mysqli->error);
        }
    }

    if (empty($email_input)) {
        $errors['email'] = "Please enter an email address.";
    } elseif (!filter_var($email_input, FILTER_VALIDATE_EMAIL)) {
        $errors['email'] = "Invalid email format.";
    } else {
        $sql_check_email = "SELECT id FROM Users WHERE email = ?";
        if ($stmt_check_email = $mysqli->prepare($sql_check_email)) {
            $stmt_check_email->bind_param("s", $param_email_check);
            $param_email_check = $email_input;
            if ($stmt_check_email->execute()) {
                $stmt_check_email->store_result();
                if ($stmt_check_email->num_rows > 0) {
                    $errors['email'] = "This email address is already registered.";
                }
            } else {
                $errors['general'] = "Error checking email uniqueness. Please try again.";
                error_log("Error executing email check: " . $stmt_check_email->error);
            }
            $stmt_check_email->close();
        } else {
            $errors['general'] = "Database error while checking email. Please try again.";
            error_log("Error preparing email check: " . $mysqli->error);
        }
    }

    if (empty($password_input_raw)) {
        $errors['password'] = "Please enter a password.";
    } elseif (strlen($password_input_raw) < 8) {
        $errors['password'] = "Password must be at least 8 characters long.";
    }

    if (empty($confirm_password_input)) {
        $errors['confirm_password'] = "Please confirm the password.";
    } elseif (empty($errors['password']) && ($password_input_raw !== $confirm_password_input)) {
        $errors['confirm_password'] = "Passwords do not match.";
    }

    if (empty($role_input)) {
        $errors['role'] = "Please select a role.";
    } elseif (!in_array($role_input, $allowed_roles)) {
        $errors['role'] = "Invalid role selected.";
    }

    if (empty($errors)) {
        $hashed_password = password_hash($password_input_raw, PASSWORD_DEFAULT);

        $sql_insert_user = "INSERT INTO Users (full_name, username, email, password_hash, role) VALUES (?, ?, ?, ?, ?)";

        if ($stmt_insert_user = $mysqli->prepare($sql_insert_user)) {
            $stmt_insert_user->bind_param("sssss", $param_fullname, $param_username, $param_email, $param_hashed_password, $param_role);

            $param_fullname = $fullname_input;
            $param_username = $username_input;
            $param_email = $email_input;
            $param_hashed_password = $hashed_password;
            $param_role = $role_input;

            if ($stmt_insert_user->execute()) {
                $_SESSION['success_message'] = "User account for '" . htmlspecialchars($param_username) . "' created successfully with role '" . htmlspecialchars($param_role) . "'.";
                header("location: " . htmlspecialchars($_SERVER["PHP_SELF"]));
                exit;
            } else {
                $errors['general'] = "Failed to create user account. Please try again.";
                error_log("Error executing user insert: " . $stmt_insert_user->error . " (Errno: " . $mysqli->errno . ")");
            }
            $stmt_insert_user->close();
        } else {
            $errors['general'] = "Database error during account creation. Please try again.";
            error_log("Error preparing user insert: " . $mysqli->error);
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Create User Account | Southern Bee Admin</title>
  <script src="<?php echo BASE_URL_FOR_LINKS; ?>/assets/js/theme.js"></script>
  <link rel="stylesheet" href="<?php echo BASE_URL_FOR_LINKS; ?>/assets/css/style.css">
</head>
<body>
  <div class="auth-container">
    <div class="logo">The Bee</div>
    <div class="auth-header">
        <h1 class="auth-title">Create New User Account</h1>
        <p class="auth-subtitle">Fill in the details to create a new user.</p>
    </div>

    <?php 
    if (!empty($success_message_from_session)) {
        echo '<div class="messages success">' . htmlspecialchars($success_message_from_session) . '</div>';
    }
    if (!empty($error_message_from_session)) { // Display general error from session
        echo '<div class="messages error">' . htmlspecialchars($error_message_from_session) . '</div>';
    }
    if (!empty($errors['general'])) { // Display general error from form processing
        echo '<div class="messages error">' . htmlspecialchars($errors['general']) . '</div>';
    }
    ?>

    <form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post" novalidate>
      <div class="form-group">
        <label for="fullname">Full Name</label>
        <input type="text" id="fullname" name="fullname" class="form-input <?php echo (!empty($errors['fullname'])) ? 'is-invalid' : ''; ?>" placeholder="First Name" value="<?php echo htmlspecialchars($fullname_input); ?>" required>
        <?php if (!empty($errors['fullname'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['fullname']); ?></div>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" class="form-input <?php echo (!empty($errors['username'])) ? 'is-invalid' : ''; ?>" placeholder="Username" value="<?php echo htmlspecialchars($username_input); ?>" required>
        <?php if (!empty($errors['username'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['username']); ?></div>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" class="form-input <?php echo (!empty($errors['email'])) ? 'is-invalid' : ''; ?>" placeholder="you@example.com" value="<?php echo htmlspecialchars($email_input); ?>" required>
        <?php if (!empty($errors['email'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['email']); ?></div>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" class="form-input <?php echo (!empty($errors['password'])) ? 'is-invalid' : ''; ?>" placeholder="•••••••• (min 8 characters)" required>
        <?php if (!empty($errors['password'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['password']); ?></div>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="confirm-password">Confirm Password</label>
        <input type="password" id="confirm-password" name="confirm-password" class="form-input <?php echo (!empty($errors['confirm_password'])) ? 'is-invalid' : ''; ?>" placeholder="••••••••" required>
        <?php if (!empty($errors['confirm_password'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['confirm_password']); ?></div>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="role">Role</label>
        <select id="role" name="role" class="form-select <?php echo (!empty($errors['role'])) ? 'is-invalid' : ''; ?>" required>
            <option value="">-- Select Role --</option>
            <?php foreach ($allowed_roles as $role_option): ?>
                <option value="<?php echo htmlspecialchars($role_option); ?>" <?php echo ($role_input === $role_option) ? 'selected' : ''; ?>>
                    <?php echo htmlspecialchars($role_option); ?>
                </option>
            <?php endforeach; ?>
        </select>
        <?php if (!empty($errors['role'])): ?>
            <div class="invalid-feedback"><?php echo htmlspecialchars($errors['role']); ?></div>
        <?php endif; ?>
      </div>

      <button type="submit" class="auth-button">Create User Account</button>
    </form>
    <a href="admin-login.php" class="auth-link">Back to Login</a>
    <!-- Or link to a user management page if applicable -->
  </div>
  <footer class="footer">
      © 2025 Southern Bee. All rights reserved.
  </footer>
</body>
</html>
<?php
if (isset($mysqli) && $mysqli instanceof mysqli) {
    $mysqli->close();
}
?>
