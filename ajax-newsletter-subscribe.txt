<?php
header('Content-Type: application/json'); // Crucial for AJAX response
require_once __DIR__ . '/config.php'; // Adjust path as necessary

$response = ['success' => false, 'message' => 'An unexpected error occurred.'];

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['subscribe_newsletter_ajax'])) {
    $email_to_subscribe = filter_var(trim($_POST['email']), FILTER_SANITIZE_EMAIL);

    if (empty($email_to_subscribe)) {
        $response['message'] = "Email address cannot be empty.";
    } elseif (!filter_var($email_to_subscribe, FILTER_VALIDATE_EMAIL)) {
        $response['message'] = "Please enter a valid email address.";
    } else {
        if (defined('MAILCHIMP_API_KEY') && defined('MAILCHIMP_LIST_ID') && defined('MAILCHIMP_SERVER_PREFIX') &&
            !empty(MAILCHIMP_API_KEY) && !empty(MAILCHIMP_LIST_ID) && !empty(MAILCHIMP_SERVER_PREFIX)) {
            
            $apiKey = MAILCHIMP_API_KEY;
            $listId = MAILCHIMP_LIST_ID;
            $serverPrefix = MAILCHIMP_SERVER_PREFIX;

            $data = ['email_address' => $email_to_subscribe, 'status' => 'subscribed'];
            $jsonData = json_encode($data);
            $url = 'https://' . $serverPrefix . '.api.mailchimp.com/3.0/lists/' . $listId . '/members/';

            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_USERPWD, 'user:' . $apiKey);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 10);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $jsonData);
            
            $result = curl_exec($ch);
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $curlError = curl_error($ch);
            curl_close($ch);

            if ($curlError) {
                $response['message'] = "Subscription failed. Please try again later. (cURL Error)";
                error_log("Mailchimp AJAX cURL Error: " . $curlError);
            } elseif ($httpCode == 200 || $httpCode == 201) {
                $response['success'] = true;
                $response['message'] = "Thank you for subscribing!";
            } else {
                $response_data = json_decode($result, true);
                $mc_error_detail = $response_data['detail'] ?? 'Unknown error';
                if (isset($response_data['title']) && $response_data['title'] === 'Member Exists') {
                    $response['message'] = "This email is already subscribed.";
                    // Optionally, you could set $response['success'] = true here too
                } else {
                    $response['message'] = "Subscription failed: " . htmlspecialchars($mc_error_detail);
                }
                error_log("Mailchimp AJAX API Error (HTTP $httpCode): " . $result);
            }
        } else {
            $response['message'] = "Newsletter configuration is missing.";
            error_log("Mailchimp API constants not defined or empty for AJAX.");
        }
    }
} else {
    $response['message'] = "Invalid request method.";
}

echo json_encode($response);
exit;
?>