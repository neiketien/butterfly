<?php
session_start();

if (isset($_SESSION["admin_loggedin"]) && $_SESSION["admin_loggedin"] === true) {
    header("location: dashboard.php");
    exit;
}

require_once __DIR__ . '/config.php';

$email_input = $password_input = "";
$email_err = $password_err = $login_err = "";

$success_message = "";
if (isset($_SESSION['success_message'])) {
    $success_message = $_SESSION['success_message'];
    unset($_SESSION['success_message']);
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $email_input = trim($_POST["email"]);

    if (empty($email_input)) {
        $email_err = "Please enter your email.";
    }

    if (empty(trim($_POST["password"]))) {
        $password_err = "Please enter your password.";
    } else {
        $password_input_raw = trim($_POST["password"]);
    }

    if (empty($email_err) && empty($password_err)) {
        $sql = "SELECT id, full_name, email, password_hash, role, status FROM Users WHERE email = ?";
        if ($stmt = $mysqli->prepare($sql)) {
            $stmt->bind_param("s", $param_email);
            $param_email = $email_input;

            if ($stmt->execute()) {
                $stmt->store_result();

                if ($stmt->num_rows == 1) {
                    $stmt->bind_result($id_db, $full_name_db, $email_db, $hashed_password_db, $role_db, $status_db);
                    if ($stmt->fetch()) {
                        if (password_verify($password_input_raw, $hashed_password_db)) {
                            if ($status_db == 'Active') {
                                $_SESSION["admin_loggedin"] = true;
                                $_SESSION["admin_id"] = $id_db;
                                $_SESSION["admin_fullname"] = $full_name_db;
                                $_SESSION["admin_email"] = $email_db;
                                $_SESSION["admin_role"] = $role_db;

                                session_regenerate_id(true);

                                $sql_update_login = "UPDATE Users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?";
                                if ($stmt_update = $mysqli->prepare($sql_update_login)) {
                                    $stmt_update->bind_param("i", $id_db);
                                    $stmt_update->execute();
                                    $stmt_update->close();
                                } else {
                                    error_log("Error updating last_login_at for user ID " . $id_db . ": " . $mysqli->error);
                                }

                                header("location: dashboard.php");
                                exit;
                            } else {
                                $login_err = "Your account is deactivated. Please contact support.";
                            }
                        } else {
                            $login_err = "Invalid email or password.";
                        }
                    }
                } else {
                    $login_err = "Invalid email or password.";
                }
            } else {
                error_log("Oops! Something went wrong with statement execution: " . $stmt->error);
                $login_err = "Oops! Something went wrong. Please try again later.";
            }
            $stmt->close();
        } else {
            error_log("Oops! Something went wrong preparing statement: " . $mysqli->error);
            $login_err = "Oops! Database error. Please try again later.";
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Southern Bee | Admin Login</title>
  <script src="<?php echo BASE_URL_FOR_LINKS; ?>/assets/js/theme.js"></script>
  <link rel="stylesheet" href="<?php echo BASE_URL_FOR_LINKS; ?>/assets/css/style.css">
</head>
<body>
  <div class="auth-container">
    <div class="logo">The Bee</div>
    <div class="auth-header">
        <h1 class="auth-title">Welcome Back!</h1>
        <p class="auth-subtitle">Enter your credentials to access your account.</p>
    </div>

    <?php 
    if(!empty($success_message)){
        echo '<div class="messages success">' . htmlspecialchars($success_message) . '</div>';
    }
    if(!empty($login_err)){
        echo '<div class="messages error">' . htmlspecialchars($login_err) . '</div>';
    }        
    ?>

    <form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post" novalidate>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" class="form-input <?php echo (!empty($email_err)) ? 'is-invalid' : ''; ?>" placeholder="you@example.com" value="<?php echo htmlspecialchars($email_input); ?>" required>
        <?php if (!empty($email_err)): ?>
            <span class="invalid-feedback"><?php echo htmlspecialchars($email_err); ?></span>
        <?php endif; ?>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" class="form-input <?php echo (!empty($password_err)) ? 'is-invalid' : ''; ?>" placeholder="••••••••" required>
        <?php if (!empty($password_err)): ?>
            <span class="invalid-feedback"><?php echo htmlspecialchars($password_err); ?></span>
        <?php endif; ?>
      </div>
      <button type="submit" class="auth-button">Log In</button>
    </form>
    <a href="admin-signup.php" class="auth-link">Don't have an account? Sign Up</a>
  </div>
   <footer class="footer">
      © 2025 Southern Bee. All rights reserved.
    </footer>
</body>
</html>
<?php
if (isset($mysqli) && $mysqli instanceof mysqli) {
    $mysqli->close();
}
?>
